# State Management[^1]

## Our small, read-only photo app is deceptively simple

- Model, View, Controller - All setup on startup and static
  - Can have a nice modular design of view components.
  - Each MVC unit independently fetches their model data.
    - Some duplicate model data fetches (e.g. UserDetail & UserList)
- Add in Session State and object creation and updating â—‹ Things get more complex for our single page app
- Examples:
  - User add new comments or photos - model data of one view changed by another view
  - Users logs out and logins into the app with a different login name - big change in model data

## Session state shared between frontend and backend

- Must be kept in sync between the browser app and the server 
  - Who, if anyone, is logged in?
- Server will need to reject any requests from users not logged in 
  - Model fetching done only at view/controller startup might not work
- Consider transitions of your photo app 
  - Login - Not logged in to logged in
    - At app startup most models are not available (e.g. sidenav user list) but become available after login is completed.
  - Logout - Logged in to not logged in
    - Requests to web server that worked before will now fail

## Models updates

- Consider what happens when new objects like users, photos, or comments
are added.
  - Models change
- Controller fetching model only at startup might not work
- Consider photo app adding a photo or comment
  - Model refresh needed

## Components are interested in outside events

- How to keep a modular design but allow controllers to be notified of things happening outside of it?
  - Example: a view component and an add component
- One option: Explicit communication interfaces in components 
  - ReactJS: Pass callback functions around to components

    ```html
    <Component commInfo={this.callMeWithInfo.bind(this)} /> 
    ```

- Better option: Listener/emitter pattern
  - Components registers interest (listen) and component detecting change signals (emit)

## React listener/emitter pattern: No opinion

- FLUX - Facebook's Application Architecture For Building user interfaces 
  - Store state in a "Store" - change with actions, notify view listeners

## Photo App current Model Data Handling

```mermaid
flowchart TD
  UserList<-->id1[Model Data]
  TopBar<-->id2[Model Data]
  UserPhotos<-->id3[Model Data]
  UserDetail<-->id4[Model Data]
  UserDetail-->TopBar
  UserPhotos-->TopBar
```

- Redux [https://redux.js.org/](https://redux.js.org/) - A predictable state container for JavaScript apps
- Relay [https://relay.dev/](https://relay.dev/) - The production-ready GraphQL client for React

## Photo App with state management

```mermaid
flowchart LR
  TopBar<--Subscribe: Context-->id1[State Manager]
  UserList<--Subscribe: UserList-->id1[State Manager]
  UserPhotos<--Subscribe: CurrentPhotos-->id1[State Manager]
  id4[UserDetail]--Set Current User-->id1[State Manager]
  id4[UserDetail]<--Subscribe: Current User Detail-->id1[State Manager]
  id1[State Manager]<---->id2[Web Server]
  id1[State Manager]<---->id3[User Actions]
  
```

[^1]: [Stanford Computer Science](https://cs.stanford.edu)
